import axios from 'axios';

// VAPI Voice AI Service for Dubai Real Estate Platform
// This service handles AI voice calling with Arabic/English support

interface VoiceCall {
  id: string;
  phoneNumber: string;
  status: 'queued' | 'ringing' | 'in-progress' | 'completed' | 'failed' | 'no-answer' | 'busy';
  duration?: number;
  recording?: string;
  transcript?: string;
  startedAt: string;
  endedAt?: string;
  cost?: number;
  summary?: string;
}

interface CallResult {
  success: boolean;
  outcome?: 'interested' | 'not_interested' | 'callback_requested' | 'no_answer' | 'wrong_number';
  notes?: string;
  nextAction?: string;
  followUpDate?: string;
}

class VAPIService {
  private apiUrl: string;
  private apiKey: string;
  private assistantIdEn: string;
  private assistantIdAr: string;

  constructor() {
    this.apiUrl = 'https://api.vapi.ai';
    this.apiKey = import.meta.env.VITE_VAPI_API_KEY || '';
    this.assistantIdEn = import.meta.env.VITE_VAPI_ASSISTANT_ID_EN || '';
    this.assistantIdAr = import.meta.env.VITE_VAPI_ASSISTANT_ID_AR || '';

    console.log('üé§ VAPI Service initialized:', {
      hasApiKey: !!this.apiKey,
      hasEnAssistant: !!this.assistantIdEn,
      hasArAssistant: !!this.assistantIdAr
    });
  }

  // ===========================================
  // VOICE CALL MANAGEMENT
  // ===========================================

  /**
   * Initiate a voice call through VAPI
   */
  async initiateCall(
    phoneNumber: string,
    clientData: {
      name: string;
      language: 'en' | 'ar';
      purpose: string;
      context?: any;
      clientId: string;
    }
  ): Promise<{ success: boolean; callId?: string; error?: string }> {
    try {
      console.log('üìû Initiating VAPI call to:', phoneNumber, 'Language:', clientData.language);

      // Clean phone number
      const cleanPhone = this.formatPhoneNumber(phoneNumber);

      // Select appropriate assistant based on language
      const assistantId = clientData.language === 'ar' 
        ? this.assistantIdAr 
        : this.assistantIdEn;

      const payload = {
        assistant: {
          id: assistantId,
          // Override assistant settings for this call
          model: {
            provider: 'openai',
            model: 'gpt-4',
            temperature: 0.7,
            maxTokens: 500
          },
          voice: {
            provider: 'elevenlabs',
            voiceId: clientData.language === 'ar' 
              ? 'pNInz6obpgDQGcFmaJgB'  // Arabic voice
              : 'EXAVITQu4vr4xnSDxMaL',  // English voice
            speed: 1.0,
            pitch: 1.0
          },
          firstMessage: clientData.language === 'ar'
            ? `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${clientData.name}ÿå ÿ£ŸÜÿß ÿ≥ÿßÿ±ÿ© ŸÖŸÜ ŸÅÿ±ŸäŸÇ ÿßŸÑÿπŸÇÿßÿ±ÿßÿ™ ÿßŸÑÿ∞ŸÉŸä. ${clientData.purpose}`
            : `Hello ${clientData.name}, this is Sarah from your AI Real Estate Team. ${clientData.purpose}`,
          systemPrompt: this.generateSystemPrompt(clientData)
        },
        phoneNumber: cleanPhone,
        customerData: {
          name: clientData.name,
          language: clientData.language,
          purpose: clientData.purpose,
          context: clientData.context,
          clientId: clientData.clientId
        }
      };

      const response = await axios.post(
        `${this.apiUrl}/call`,
        payload,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 30000
        }
      );

      console.log('‚úÖ VAPI call initiated successfully:', response.data);

      return {
        success: true,
        callId: response.data.id,
        error: null
      };
    } catch (error) {
      console.error('‚ùå VAPI call initiation failed:', error);
      return {
        success: false,
        error: this.handleError(error)
      };
    }
  }

  /**
   * Get call status and details
   */
  async getCallStatus(callId: string): Promise<VoiceCall | null> {
    try {
      const response = await axios.get(
        `${this.apiUrl}/call/${callId}`,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          },
          timeout: 10000
        }
      );

      const callData = response.data;

      return {
        id: callData.id,
        phoneNumber: callData.phoneNumber,
        status: callData.status,
        duration: callData.duration,
        recording: callData.recordingUrl,
        transcript: callData.transcript,
        startedAt: callData.createdAt,
        endedAt: callData.endedAt,
        cost: callData.cost,
        summary: callData.summary
      };
    } catch (error) {
      console.error('‚ùå Failed to get call status:', error);
      return null;
    }
  }

  /**
   * Get call transcript and analysis
   */
  async getCallAnalysis(callId: string): Promise<CallResult | null> {
    try {
      const response = await axios.get(
        `${this.apiUrl}/call/${callId}/analysis`,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          },
          timeout: 10000
        }
      );

      return {
        success: response.data.callSuccessful || false,
        outcome: response.data.outcome,
        notes: response.data.summary,
        nextAction: response.data.recommendedAction,
        followUpDate: response.data.followUpDate
      };
    } catch (error) {
      console.error('‚ùå Failed to get call analysis:', error);
      return null;
    }
  }

  // ===========================================
  // ASSISTANT MANAGEMENT
  // ===========================================

  /**
   * Create a custom assistant for specific use cases
   */
  async createAssistant(
    name: string,
    language: 'en' | 'ar',
    purpose: string,
    personality: string
  ): Promise<{ success: boolean; assistantId?: string; error?: string }> {
    try {
      const payload = {
        name: name,
        model: {
          provider: 'openai',
          model: 'gpt-4',
          temperature: 0.7,
          maxTokens: 500
        },
        voice: {
          provider: 'elevenlabs',
          voiceId: language === 'ar' 
            ? 'pNInz6obpgDQGcFmaJgB'  // Arabic voice
            : 'EXAVITQu4vr4xnSDxMaL',  // English voice
          speed: 1.0,
          pitch: 1.0
        },
        firstMessage: language === 'ar'
          ? 'ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑÿπŸÇÿßÿ±ÿßÿ™ ŸÅŸä ÿØÿ®Ÿä.'
          : 'Hello, I\'m your AI Real Estate Assistant for Dubai.',
        systemPrompt: this.generateSystemPrompt({
          language,
          purpose,
          context: { personality }
        })
      };

      const response = await axios.post(
        `${this.apiUrl}/assistant`,
        payload,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 15000
        }
      );

      return {
        success: true,
        assistantId: response.data.id,
        error: null
      };
    } catch (error) {
      console.error('‚ùå Failed to create assistant:', error);
      return {
        success: false,
        error: this.handleError(error)
      };
    }
  }

  // ===========================================
  // CALL HISTORY & ANALYTICS
  // ===========================================

  /**
   * Get call history for a client
   */
  async getCallHistory(
    clientId: string,
    limit: number = 50
  ): Promise<VoiceCall[]> {
    try {
      const response = await axios.get(
        `${this.apiUrl}/calls`,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          },
          params: {
            clientId: clientId,
            limit: limit,
            sortBy: 'createdAt',
            sortOrder: 'desc'
          },
          timeout: 10000
        }
      );

      return response.data.calls || [];
    } catch (error) {
      console.error('‚ùå Failed to get call history:', error);
      return [];
    }
  }

  /**
   * Get call analytics
   */
  async getCallAnalytics(
    clientId: string,
    startDate: string,
    endDate: string
  ): Promise<any> {
    try {
      const response = await axios.get(
        `${this.apiUrl}/analytics/calls`,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          },
          params: {
            clientId: clientId,
            startDate: startDate,
            endDate: endDate
          },
          timeout: 10000
        }
      );

      return response.data;
    } catch (error) {
      console.error('‚ùå Failed to get call analytics:', error);
      return null;
    }
  }

  // ===========================================
  // WEBHOOK HANDLING
  // ===========================================

  /**
   * Process VAPI webhook events
   */
  processWebhookEvent(event: any): void {
    console.log('üì° Processing VAPI webhook event:', event.type);

    switch (event.type) {
      case 'call-started':
        console.log('üìû Call started:', event.data.callId);
        this.handleCallStarted(event.data);
        break;
      
      case 'call-ended':
        console.log('üìû Call ended:', event.data.callId, 'Duration:', event.data.duration);
        this.handleCallEnded(event.data);
        break;
      
      case 'transcript':
        console.log('üí¨ Call transcript:', event.data.callId);
        this.handleTranscriptUpdate(event.data);
        break;
      
      case 'call-analysis':
        console.log('üìä Call analysis ready:', event.data.callId);
        this.handleCallAnalysis(event.data);
        break;
      
      default:
        console.log('‚ùì Unknown webhook event type:', event.type);
    }
  }

  // ===========================================
  // HELPER METHODS
  // ===========================================

  /**
   * Generate system prompt based on context
   */
  private generateSystemPrompt(clientData: any): string {
    const basePrompt = clientData.language === 'ar' 
      ? this.getArabicSystemPrompt()
      : this.getEnglishSystemPrompt();

    // Add specific context based on purpose
    let contextPrompt = '';
    if (clientData.purpose?.includes('qualification')) {
      contextPrompt = clientData.language === 'ar'
        ? '\n\nŸáÿØŸÅŸÉ ŸáŸà ÿ™ÿ£ŸáŸäŸÑ ÿßŸÑÿπŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ ŸàŸÅŸáŸÖ ÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™Ÿá ÿßŸÑÿπŸÇÿßÿ±Ÿäÿ©.'
        : '\n\nYour goal is to qualify the lead and understand their real estate needs.';
    } else if (clientData.purpose?.includes('follow-up')) {
      contextPrompt = clientData.language === 'ar'
        ? '\n\nŸáÿ∞Ÿá ŸÖŸÉÿßŸÑŸÖÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÑÿπŸÖŸäŸÑ ÿ≥ÿßÿ®ŸÇ. ŸÉŸÜ ŸàÿØŸàÿØÿßŸã ŸàŸÖŸÅŸäÿØÿßŸã.'
        : '\n\nThis is a follow-up call with a previous client. Be friendly and helpful.';
    }

    return basePrompt + contextPrompt;
  }

  /**
   * English system prompt
   */
  private getEnglishSystemPrompt(): string {
    return `You are Sarah Al-Mansouri, a senior AI real estate consultant for Dubai properties. You are professional, knowledgeable, and helpful.

Key guidelines:
- Keep conversations concise and focused (2-3 minutes max)
- Ask relevant questions about property needs
- Provide helpful Dubai market insights
- Be respectful of the client's time
- Suggest next steps (viewing, consultation, etc.)
- Handle objections professionally
- If the client is not interested, thank them politely and end the call

Dubai market knowledge:
- Popular areas: Downtown, Marina, JBR, Palm Jumeirah, Business Bay
- Investment opportunities available
- Golden Visa eligibility with AED 2M+ investment
- Current market trends and pricing

Always end calls with a clear next step or polite closure.`;
  }

  /**
   * Arabic system prompt
   */
  private getArabicSystemPrompt(): string {
    return `ÿ£ŸÜÿ™ ÿ≥ÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿµŸàÿ±Ÿäÿå ŸÖÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿπŸÇÿßÿ±Ÿäÿ© ŸÉÿ®Ÿäÿ±ÿ© ŸÖÿ™ÿÆÿµÿµÿ© ŸÅŸä ÿπŸÇÿßÿ±ÿßÿ™ ÿØÿ®Ÿä. ÿ£ŸÜÿ™ ŸÖÿ≠ÿ™ÿ±ŸÅÿ© Ÿàÿ∞ÿßÿ™ ŸÖÿπÿ±ŸÅÿ© Ÿàÿßÿ≥ÿπÿ© ŸàŸÖŸÅŸäÿØÿ©.

ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©:
- ÿ≠ÿßŸÅÿ∏Ÿä ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ŸÖÿÆÿ™ÿµÿ±ÿ© ŸàŸÖÿ±ŸÉÿ≤ÿ© (2-3 ÿØŸÇÿßÿ¶ŸÇ ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ)
- ÿßÿ∑ÿ±ÿ≠Ÿä ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ∞ÿßÿ™ ÿµŸÑÿ© ÿ≠ŸàŸÑ ÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™ ÿßŸÑÿπŸÇÿßÿ±
- ŸÇÿØŸÖŸä ÿ±ÿ§Ÿâ ŸÖŸÅŸäÿØÿ© ÿ≠ŸàŸÑ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿπŸÇÿßÿ±Ÿä ŸÅŸä ÿØÿ®Ÿä
- ÿßÿ≠ÿ™ÿ±ŸÖŸä ŸàŸÇÿ™ ÿßŸÑÿπŸÖŸäŸÑ
- ÿßŸÇÿ™ÿ±ÿ≠Ÿä ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸäÿ© (ŸÖÿπÿßŸäŸÜÿ©ÿå ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ©ÿå ÿ•ŸÑÿÆ)
- ÿ™ÿπÿßŸÖŸÑŸä ŸÖÿπ ÿßŸÑÿßÿπÿ™ÿ±ÿßÿ∂ÿßÿ™ ÿ®ŸÖŸáŸÜŸäÿ©
- ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿßŸÑÿπŸÖŸäŸÑ ŸÖŸáÿ™ŸÖÿßŸãÿå ÿßÿ¥ŸÉÿ±ŸäŸá ÿ®ÿ£ÿØÿ® Ÿàÿ£ŸÜŸáŸä ÿßŸÑŸÖŸÉÿßŸÑŸÖÿ©

ŸÖÿπÿ±ŸÅÿ© ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿπŸÇÿßÿ±Ÿä ŸÅŸä ÿØÿ®Ÿä:
- ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©: Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿØŸäŸÜÿ©ÿå ÿßŸÑŸÖÿßÿ±ŸäŸÜÿßÿå ÿ¨Ÿä ÿ®Ÿä ÿ¢ÿ±ÿå ŸÜÿÆŸÑÿ© ÿ¨ŸÖŸäÿ±ÿßÿå ÿßŸÑÿÆŸÑŸäÿ¨ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä
- ŸÅÿ±ÿµ ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿäÿ© ŸÖÿ™ÿßÿ≠ÿ©
- ÿ£ŸáŸÑŸäÿ© ÿßŸÑÿ•ŸÇÿßŸÖÿ© ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© ÿ®ÿ¥ÿ±ÿßÿ° ÿπŸÇÿßÿ± ÿ®ŸÇŸäŸÖÿ© 2 ŸÖŸÑŸäŸàŸÜ ÿØÿ±ŸáŸÖ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±
- ÿßÿ™ÿ¨ÿßŸáÿßÿ™ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸàÿßŸÑÿ£ÿ≥ÿπÿßÿ±

ÿ£ŸÜŸáŸä ÿßŸÑŸÖŸÉÿßŸÑŸÖÿßÿ™ ÿØÿßÿ¶ŸÖÿßŸã ÿ®ÿÆÿ∑Ÿàÿ© Ÿàÿßÿ∂ÿ≠ÿ© ÿ£Ÿà ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸáÿ∞ÿ®.`;
  }

  /**
   * Format phone number for VAPI
   */
  private formatPhoneNumber(phoneNumber: string): string {
    // Remove all non-digit characters
    const cleaned = phoneNumber.replace(/[^\d]/g, '');
    
    // Add + prefix and ensure UAE format
    if (cleaned.startsWith('971')) {
      return '+' + cleaned;
    } else if (cleaned.startsWith('5') && cleaned.length === 9) {
      return '+971' + cleaned;
    }
    
    return '+' + cleaned;
  }

  /**
   * Handle webhook events
   */
  private handleCallStarted(data: any): void {
    // Update database with call start
    // Notify dashboard in real-time
  }

  private handleCallEnded(data: any): void {
    // Update database with call results
    // Generate follow-up actions
  }

  private handleTranscriptUpdate(data: any): void {
    // Store transcript for analysis
    // Update real-time dashboard
  }

  private handleCallAnalysis(data: any): void {
    // Process AI analysis
    // Create follow-up tasks
    // Update lead status
  }

  /**
   * Handle errors consistently
   */
  private handleError(error: any): string {
    if (axios.isAxiosError(error)) {
      if (error.response?.status === 401) {
        return 'Invalid VAPI API key. Please check your configuration.';
      }
      if (error.response?.status === 402) {
        return 'Insufficient VAPI credits. Please add credits to your account.';
      }
      if (error.response?.status === 429) {
        return 'VAPI rate limit exceeded. Please try again later.';
      }
      return `VAPI API error: ${error.response?.data?.message || error.message}`;
    }
    
    return error.message || 'Unknown VAPI error occurred';
  }

  /**
   * Test VAPI connection
   */
  async testConnection(): Promise<{ success: boolean; message: string }> {
    try {
      console.log('üîç Testing VAPI connection...');
      
      const response = await axios.get(
        `${this.apiUrl}/assistant/${this.assistantIdEn}`,
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          },
          timeout: 5000
        }
      );

      if (response.data) {
        console.log('‚úÖ VAPI connection successful');
        return {
          success: true,
          message: 'Successfully connected to VAPI'
        };
      }

      return {
        success: false,
        message: 'Failed to retrieve assistant information'
      };
    } catch (error) {
      console.error('‚ùå VAPI connection test failed:', error);
      return {
        success: false,
        message: this.handleError(error)
      };
    }
  }
}

// Export singleton instance
export const vapiService = new VAPIService();
export default vapiService;

// Development helper
if (import.meta.env.DEV) {
  console.log('üé§ VAPI Service loaded in development mode');
  console.log('üìã Available methods:', [
    'initiateCall',
    'getCallStatus',
    'getCallAnalysis',
    'createAssistant',
    'getCallHistory',
    'getCallAnalytics',
    'testConnection'
  ]);
}